<!DOCTYPE html>
<html>
<head>
   <title>Connect Four </title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
  <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcTTRIGt6nDMzRekANsR6xEUvLhbBzbZKva6ZVhjQOGWX5CX106Y&usqp=CAU">
   

  <!-- for the social media icon -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">


<style>
html, body {
  height: 100%;
  overflow: hidden;
  margin: 0;
}
#content {
  height: 100%;
}
#left {
  float: left;
  width: 20%;
  background: white;
  height: 100%;
  overflow-y: auto;

  
}
#right {
  float: left;
  width: 80%;
  background: #FAE5D3  ;
  height: 90%;
  overflow-y: auto;
}

#sendMessageDiv{
  width:80%;
  height:10%;
  position: absolute;
  bottom: 0;
 //padding-bottom:10px;
 padding-left:15px;
}
#receiverName{
  width:80%;
  height:10%;
  position: absolute;
  top: 50;
 padding-bottom:10px;
 padding-left:15px;
}
#senderName{
  width:20%;
  height:10%;
  position: absolute;
  top: 50;
 margin-bottom:15px;
}

i.icon-blue {
    color: white;
}
nav {
       height: 50px;
        line-height: 50px;
    }

   </style>
   <style>
			.click_button {
				height: 42px;
				width: 42px;
				border-radius: 24px;
				background-color: rgba(255,0,0,1);
				cursor: pointer;
			}
			
			/* Make each piece square - 32x32, set the border-radius to 16px (so that it appears round) and center it using margin-left
			and margin-right: auto */
			.piece {
				height: 25px;
				width: 25px;
				display:block;
				border-radius: 50%;
				margin-left: auto;
				margin-right: auto;
			}
      
			
			/* Player 0 (no player) will have a light-grey background */
			.player0 {
				background-color: white; //#DDDDDD; /* hex colors were used, but rgb/rgba could be used as well */
			}
			
			/* player 1 will have a red background */
			.player1 {
				background-color: #FF0000;
			}
			
			/* player 2 will have a blue background */
			.player2 {
				background-color: #0000FF;	
			}
			
			/* set the board square to having a dark-grey border, and to be 36x36 square */
			.board_square {
				//border: 0px solid #555555;
				//height: 24px;
				//width: 1px;
			}
      #game_table{
        background:yellow;
        border:2px solid black;
        margin-left:5px;
        width:260px;
        height:260px;
      }
			 

</style>


</head>
<body>    
        <!-- NAVBAR --> 
<div class="navbar-fixed ">
    <nav class="nav-wrapper blue">
      <div class="container">
        <a href="#" class="sidenav-trigger" data-target="mobile-links1">
          <i class="material-icons">menu</i>
        </a>
        <ul class="right hide-on-med-and-down">
          <li class="logged-in" style="display:none;">
            <a href="#" class="modal-trigger" data-target="modal-account">Account Info</a>
          </li>
          <li class="logged-in" style="display:none;">
            <a href="#" class="modal-trigger" data-target="modal-logout" >Logout</a>
          </li>
          <li class="logged-out" style="display:none;">
            <a href="#" class="modal-trigger" data-target="modal-login">Login</a>
          </li>
          <li class="logged-out" style="display:none;">
            <a href="#" class="modal-trigger" data-target="modal-signup">Sign up</a>
          </li>
          
        </ul>
      </div>
    </nav>
  </div>

  <ul class="sidenav sidenav-close" id="mobile-links1">
         <li class="logged-in" style="display:none;">
           <div class="user-view">
             <div class="background">
                <img src="https://images.pexels.com/photos/531880/pexels-photo-531880.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500">
             </div>
             <a href="#user"><img class="circle" src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/User_icon_2.svg/220px-User_icon_2.svg.png"></a>
             <a href="#name"><span class="white-text name" ></span></a>
             <a href="#email"><span class="white-text email"></span></a>
          </div>

          <li class="logged-out" style="display:none;">
           <div class="user-view">
             <div class="background">
                <img src="https://images.pexels.com/photos/531880/pexels-photo-531880.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500">
             </div>
             <a href="#user"><img class="circle" src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/User_icon_2.svg/220px-User_icon_2.svg.png"></a>
             <a href="#"><span class="white-text name" >Login to view the user info.</span> </a>
          </div>

            <!--<a href="#" class="modal-trigger" data-target="modal-account">Account Info</a>   -->
         </li>
          <li class="logged-in" style="display:none;">
            <a href="#" class="modal-trigger" data-target="modal-logout" ><i class="material-icons">exit_to_app</i>Logout</a>
          </li>
          <li class="logged-out" style="display:none;">
            <a href="#" class="modal-trigger" data-target="modal-login">Login</a>
          </li>
          <li class="logged-out" style="display:none;">
            <a href="#" class="modal-trigger" data-target="modal-signup">Sign up</a>
          </li>
    
  </ul>

 <!-- SIGN UP MODAL -->
  <div id="modal-signup" class="modal">
    <div class="modal-content">
      <h4>Sign up</h4><br />
      <form id="signup-form">
        <div class="input-field">
          <input type="text" id="signup-bio" required />
          <label for="signup-bio">Name</label>
        </div>
        <div class="input-field">
          <input type="email" id="signup-email" required />
          <label for="signup-email">Email address</label>
        </div>
        <div class="input-field">
          <input type="password" id="signup-password" required />
          <label for="signup-password">Choose password</label>
        </div>
        <button class="btn yellow darken-2 z-depth-0">Sign up</button>
        <p class="error pink-text center-align"></p>
      </form>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="modal-login" class="modal">
    <div class="modal-content">
      <h4>Login</h4><br />
      <form id="login-form">
        <div class="input-field">
          <input type="email" id="login-email" required />
          <label for="login-email">Email address</label>
        </div>
        <div class="input-field">
          <input type="password" id="login-password" required />
          <label for="login-password">Your password</label>
        </div>
        <button class="btn yellow darken-2 z-depth-0">Login</button>
       
        <!--<a href='#' onclick="forgotPass();">Forgot Password?</a>-->
        <p class="error pink-text center-align"></p>
      </form>
      <a href="#" class="modal-trigger" data-target="modal-resetPassword" id="forgotLink">Forgot password?</a>
    </div>
  </div>



  <!-- PASSWORD RESET MODAL -->
  <div id="modal-resetPassword" class="modal">
    <div class="modal-content">
      <h4>Reset Password</h4><br />
      <form id="reset-password">
        <div class="input-field">
          <input type="email" id="login-email" required />
          <label for="login-email">Email address</label>
        </div>
        <button class="btn yellow darken-2 z-depth-0" >Reset</button>
        <p class="error pink-text center-align"></p>
      </form>
    </div>
  </div>


  <!-- ACCOUNT MODAL -->
  <div id="modal-account" class="modal">
    <div class="modal-content center-align">
      <h4>Account details</h4><br />
           <div class="user-view">
             <a href="#user"><img class="circle" src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/User_icon_2.svg/220px-User_icon_2.svg.png"></a>
          </div>
            <!--<a href="#" class="modal-trigger" data-target="modal-account">Account Info</a>   -->
        <div class="account-details"></div> 
    </div>
  </div>

  <!--LOGOUT CONFIRMATION BOX-->
  <div id="modal-logout" class="modal">
    <div class="modal-content">
      <h4>Logout</h4>
      <p>Do you want to logout?</p>
    </div>
    <div class="modal-footer">
            <a href="#" onclick="logouts();" class="modal-action modal-close waves-effect waves-green btn-flat ">Yes</a>
            <a href="#" class="modal-action modal-close waves-effect waves-red btn-flat ">No</a>
   </div>
  </div>
 
 
    <div id="left"> 
       <div  id="senderName" style="height:60px;background:#E8E6E6;border:1px solid #D1D0D0;margin-bottom:15px;">
         <b><p class="logged-out" style="font-size:100%;color:red;">User is not logged-in.</p></b>
         <b><p class="logged-in" id="userInformation1" style="font-size:80%;word-wrap:break-word;"></p></b>
         <p class="logged-in" id="userInformation2" style="font-size:50%;word-wrap:break-word;"></p>
      </div>
        <!--<header style="height:60px;background:#E8E6E6;border:1px solid #D1D0D0;position:absolute;width:100%;">
        <b><p class="logged-out" style="font-size:100%;color:red;">User is not logged-in.</p></b>
         <b><p class="logged-in" id="userInformation1" style="font-size:80%;"></p></b>
         <p class="logged-in" id="userInformation2" style="font-size:80%;"></p>
        </header>-->
        <div class="logged-in" id="friendList"><h5 style="background:#D0ECE7;word-wrap:break-word;margin-top:60px;">All Users</h5></div>
        <div id="lists" class="logged-in"></div>
        <div style="height:60px;"class="logged-in" ></div>
     </div>

    <div id="right">
      <div  id="receiverName" style="height:60px;background:#E8E6E6;border:1px solid #D1D0D0;margin-bottom:15px;">
         <p class="logged-in" id="rName"></p>
         <p class="logged-in" id="rEmail"></p>
      </div>
      <div style="height:70px;background:#FAE5D3;"></div>

      

      
		<div id="gameboard" style="display:none;">
    <select id="firstPlayer"  onchange='addFirstPlayer(this.value);' style="display:block;width:260px;" >
        <option value="" selected>Select the first Player</option>
      </select>
      <div id="frstPlr" style="padding-left:4px;">Player 1 :</div>
			<!-- The game_info div allows game-specific information to easily be displayed -->
			<div id="game_info" style="padding-left:4px;"></div>
      
			<table id="game_table">

				<script> 
        for(var row=0; row<=5; row++) {
					document.writeln("<tr>");	
					for (var col=0; col<=6; col++) {
						//write each table data element - with the row and col variables in the ID so it can be accessed later.
						document.writeln("<td id='square_" + row + "_"+ col +"' onclick='drop("+col+");'  class='board_square'></td>");							
					}
					//write the closing table row tag.
					document.writeln("</tr>");	
				}						
										
				</script>
        
			</table>
      <button id="begin_game" class="btn red" onclick="doFunc();" style="display:none;">Clear All</button>
			<!-- game_status is a place for the game to provide status updates. -->
			<div id="game_status" ></div>
    </div>


     <div class="logged-in" id="showChat">
     </div>
      <div style="height:70px;background:#FAE5D3;"></div>
      <div class="logged-in" style="background:#F4F2F2;" id="sendMessageDiv">
     
        <input type="text" id="userText" placeholder="Type a message" style="width:75%;border-radius:25px;border:none;background:white;padding-left:15px;">
        <button id="send" onclick="addDataToDatabase();" type="submit" style="width:5%;margin-top:10px;border:none;background:#F4F2F2 ;" disabled><i style="background:#28B463;border-radius:50%;font-size:25px;" class="material-icons icon-blue">send</i></button>
   
      
     </div>
   </div>

   <script>
   function addFirstPlayer(email){
     window.firstPlayerIs = email;
      database.ref('Connect4Game/'+dbs1+'/'+dbs2+'/FirstPlayer/').update({first_play:email});
      database.ref('Connect4Game/'+db1+'/'+db2+'/ActivePlayerEmail/').update({active_play_email:email});
      
      setUpTurn();
   }
   function doFunc(){
    storeInDatabase('','','',"-");
    beginGame(); 
    database.ref('Connect4Game/'+db1+'/'+db2+'/ActivePlayer') .update({active_play:1});
    database.ref('Connect4Game/'+db1+'/'+db2+'/ActivePlayerEmail/').update({active_play_email:""});
    database.ref('Connect4Game/'+db1+'/'+db2+'/FirstPlayer/').update({first_play:""});
    document.getElementById("firstPlayer").disabled = false;
    document.getElementById("game_info").innerHTML ="Current Player:";
    document.getElementById("game_table").style.background ="yellow";
   }

   </script>

   <script>
   //var objDiv = document.getElementById("right");
    //objDiv.scrollTop = objDiv.scrollHeight;
   window.toWhom ="";
     function addDataToDatabase(){
       var emailSender = window.userIs.email.replace(/[^a-zA-Z0-9]/g, "");
       var emailReceiver = window.toWhom.replace(/[^a-zA-Z0-9]/g, "");

       var compare =  emailSender.localeCompare(emailReceiver);

       var time = new Date().toString().slice(16,21);
       if(compare == -1){
         dbName1 = emailSender;
         dbName2 = emailSender+'-'+emailReceiver;
       }
       else{
         dbName1 = emailReceiver;
         dbName2 = emailReceiver+'-'+emailSender;
       }

       var reff = database.ref('LetsChat/'+dbName1+'/'+dbName2);
       var data = document.getElementById('userText').value;
       if(data.trim().length >0){
            var data1 = {
              From : window.userIs.email,
              To : window.toWhom,
              Text : data,
              Time : time
           }
       reff.push(data1);   // reff.set(data1); will override the data
       document.getElementById('userText').value = "";
      }
     
     }
     

     
   </script>


 <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-auth.js"></script>
  <!--<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-firestore.js"></script>-->
  <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyCs95pOO2eAgLtep3v7eaTrJJm1X1RXJ3U",
    authDomain: "chat-app-9abe7.firebaseapp.com",
    databaseURL: "https://chat-app-9abe7.firebaseio.com",
    projectId: "chat-app-9abe7",
    storageBucket: "chat-app-9abe7.appspot.com",
    messagingSenderId: "625053413425",
    appId: "1:625053413425:web:bb022f1979ae03e4066510",
    measurementId: "G-GC9QP143PT"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  
  // make auth and firestore references
    const auth = firebase.auth();
    const db = firebase.firestore();

    const database =firebase.database();
    

</script>
 
  
  <!-- Compiled and minified JavaScript -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>


  <script>
  
    $(document).ready(function(){
      $('.sidenav').sidenav();  //to show the nav bar when window is resized.
      $('#forgotLink').click(function(e){
        e.preventDefault();
        $('#modal-login').modal({
          dismissible: true
        });
        $('#modal-resetPassword').modal('open');
      }); 
      $('#userText') .keyup(function(e){
         if(document.getElementById('userText').value.trim().length >0){
            $('#send').attr('disabled', false);
            $("#send").css("cursor","pointer");
         }
         else{
           $('#send').attr('disabled', true);
           $("#send").css("cursor","context-menu");
         }
      });
      
      $("#send").click(function(){
         $('#right').animate({
           scrollTop: $('#right').get(0).scrollHeight
         }, 200);
        });

    });
  </script> 

  <script>
  


//window.toWhom="raviganeshmbhat999@gmail.com";
  

       // listen for auth status changes
auth.onAuthStateChanged(user => {
  window.userIs=user;
    if (user) { //authorised user, but not confirmed the email
    db.collection('users').doc(user.uid).get().then(doc => {
        document.getElementById('userInformation1').innerHTML = doc.data().bio;
        //document.getElementById('userInformation2').innerHTML = user.email;
        });
         selectValues={};
            storageRef.child('/Images/'+window.userIs.email+'/').listAll().then(function(result){
        result.prefixes.forEach(function(imageRef){
          //console.log(imageRef.name);
          selectValues[imageRef.name] = imageRef.name;
         });

    $.each(selectValues, function(key, value) {
     if(key != window.userIs.email){ 
     $('#categoryList1')
          .append($('<option>', { value : key })
          .text(value));
          $('select').formSelect();
     }
     });

      });   
    console.log(user);
       setupUI(user); 
      
    } else {
        setupUI();
    }
  });

// signup
const signupForm = document.querySelector('#signup-form');
signupForm.addEventListener('submit', (e) => {
  e.preventDefault();
  
  // get user info
  const email = signupForm['signup-email'].value;
  const password = signupForm['signup-password'].value;
  

  // sign up the user
  auth.createUserWithEmailAndPassword(email, password).then(cred => {
    return db.collection('users').doc(cred.user.uid).set({
        bio: signupForm['signup-bio'].value,
        email : email
      });
    }).then(() => {
    // close the signup modal & reset form
    const modal = document.querySelector('#modal-signup');
    M.Modal.getInstance(modal).close();
    signupForm.reset();
    signupForm.querySelector('.error').innerHTML = '';
    location.reload();
  }).catch(err => {
    signupForm.querySelector('.error').innerHTML = err.message;
  });
  
});

// login
const loginForm = document.querySelector('#login-form');
loginForm.addEventListener('submit', (e) => {
  e.preventDefault();
  
  // get user info
  const email = loginForm['login-email'].value;
  console.log(email);
  const password = loginForm['login-password'].value;

  // log the user in
  auth.signInWithEmailAndPassword(email, password).then((cred) => {
    console.log(cred.user);
    // close the signup modal & reset form
    const modal = document.querySelector('#modal-login');
    M.Modal.getInstance(modal).close();
    loginForm.reset();
    loginForm.querySelector('.error').innerHTML = '';
    location.reload();
  }).catch(err => {
    loginForm.querySelector('.error').innerHTML = err.message;
  });

});

// PASSWORD RESET 
const resetPassForm = document.querySelector('#reset-password');
resetPassForm.addEventListener('submit', (e) => {
  e.preventDefault();
  
  // get user info
  var auth = firebase.auth();
  var user = firebase.auth().currentUser;
  var emailAddress = resetPassForm['login-email'].value;

  auth.sendPasswordResetEmail(emailAddress).then(function() {
    // Email sent.
      alert("Password reset email is sent to "+emailAddress);
    const modal = document.querySelector('#modal-resetPassword');
     M.Modal.getInstance(modal).close();
     resetPassForm.reset();
  }).catch(function(error) {
      // An error happened.
      alert("Error in sending the password reset email to "+emailAddress);
  });
});

</script>

  <script>

  function showChat(from, chat, time){
    var li = document.createElement('div');
    var timediv = document.createElement('div');
    if(from == window.userIs.email){
      li.setAttribute("style", "font-size:70%;width:70%;padding-left:10px;margin-bottom:15px;margin-left:auto;margin-right:10%;background:#F7DC6F;margin-right:10px;border-radius:5px;");
    }
    else{
      li.setAttribute("style", "font-size:70%;width:70%;padding-left:10px;margin-bottom:15px;margin-left:5%;margin-right:auto;background:white;margin-right:10px;border-radius:5px;");
    }
    timediv.setAttribute("style", "padding-left:80%;font-size:10px;");
    timediv.textContent = time;
    li.textContent = chat;
    li.appendChild(timediv);
    document.querySelector('#showChat').appendChild(li);
    $("#right").scrollTop($("#right").prop('scrollHeight'));
  }
  function callShowChat(n1, n2){
    var dbName1 = n1;
    var dbName2 = n2;
    //console.log("callahowchat");
    //console.log(n1,n2);
     database.ref('LetsChat/'+dbName1+'/'+dbName2).on('value', snap =>{
       //console.log(snap.val());
       document.querySelector("#showChat").innerHTML ="";
       snap.forEach(function(childSnapshot){
          var txt = childSnapshot.val().Text;
          var time = childSnapshot.val().Time;
          showChat(childSnapshot.val().From, txt, time);
        });
     });
  }
  function reply_click(id){
    //console.log(id);
    db1 = id.substring(0, id.indexOf('@'));
    db2 = id.substring(id.indexOf('@')+1,id.indexOf('$'));
    window.dbs1 = db1;
    window.dbs2 = db2;
    window.toWhoms = id.substring(id.indexOf('$')+1,id.indexOf('#'));
     
    document.getElementById("begin_game").style.display = "block";
    document.getElementById("begin_game").setAttribute("style","margin-left:80px;margin-bottom:10px;");
    document.getElementById("gameboard").style.display = "block";
    
    document.getElementById("rEmail").innerHTML = id.substring(id.indexOf('#')+1,);
    database.ref('Connect4Game/'+dbs1+'/'+dbs2+'/ActivePlayer').once('value', snap =>{
           //console.log(snap.val());
           if(snap.val() == null){
             database.ref('Connect4Game/'+db1+'/'+db2+'/ActivePlayer/').update({active_play:1});
           }
        });
    database.ref('Connect4Game/'+dbs1+'/'+dbs2+'/ActivePlayer').once('value', snap =>{
      if(snap.val() == null){
         database.ref('Connect4Game/'+db1+'/'+db2+'/FirstPlayer/').update({first_play:""});
         setUpTurn();
      } 
    });
    $("#firstPlayer option:not(:first)").remove();
    var x = document.getElementById('firstPlayer');
    var opt1 = document.createElement('option');
    opt1.text = window.userIs.email;
    var opt2 = document.createElement('option');
    opt2.text = window.toWhoms;
    x.add(opt1);
    x.add(opt2);

    database.ref('Connect4Game/'+dbs1+'/'+dbs2+'/FirstPlayer').on('value', snap =>{
           player = snap.val().first_play;
           document.getElementById("frstPlr").innerHTML = "Player 1 : "+player;
           setUpTurn();
        });
    window.toWhom = window.toWhoms.replace(/[^a-zA-Z0-9]/g, "");
    callShowChat(db1,db2);
    //beginGame();
    callShowBox(db1,db2);
  }
  var storageRef = firebase.storage().ref();
      // DOM elements
const loggedOutLinks = document.querySelectorAll('.logged-out');
const loggedInLinks = document.querySelectorAll('.logged-in');
const accountDetails = document.querySelector('.account-details');


const setupUI = (user) => {
    if (user) {
      console.log(user.email)
        // account info
        db.collection('users').doc(user.uid).get().then(doc => {
          window.userName = doc.data().bio;
          const html = `
            <div style="color:darkblue;">${doc.data().bio}</div>
            <div style="color:darkblue;">${user.email}</div>
          `;
          accountDetails.innerHTML = html;
          document.querySelector('.name').innerHTML = doc.data().bio;
          document.querySelector('.email').innerHTML = user.email;
        });
        // toggle user UI elements
        loggedInLinks.forEach(item => item.style.display = 'block');
        loggedOutLinks.forEach(item => item.style.display = 'none');

        firebase.firestore().collection('users').get().then((querySnapshot) => {
      const tempDoc = querySnapshot.docs.map((doc) => {
        if(doc.data().bio != window.userName){
          var emailSender = window.userIs.email.replace(/[^a-zA-Z0-9]/g, "");
          var emailReceiver = doc.data().email.replace(/[^a-zA-Z0-9]/g, "");

           var compare =  emailSender.localeCompare(emailReceiver);
           window.toWhoms = doc.data().email;
          window.toWhom =emailReceiver;
          if(compare == -1){
            n1 = emailSender;
            n2 = emailSender+'-'+emailReceiver;
         }
          else{
            n1 = emailReceiver;
            n2 = emailReceiver+'-'+emailSender;
         }
           var li = document.createElement('div');
           var uname = document.createElement('p');
           var email = document.createElement('p');
           //var newMsg = document.createElement('span');
           
           /*li.setAttribute("style","height:50px;border:4px solid #45B39D;border-radius:5px;padding-left:10px;margin-right:5px;cursor:pointer;margin-bottom:5px;");
           */
           li.setAttribute("style","border:4px solid #45B39D;border-radius:5px;padding-left:10px;cursor:pointer;margin-bottom:5px;");
           li.setAttribute("id",n1+"@"+n2+"$"+doc.data().email+"#"+doc.data().bio);
           li.setAttribute("class","usersNames");
           li.setAttribute("onMouseOver","this.style.background='#E8F8F5'");
           li.setAttribute("onMouseOut","this.style.background='#ffffff'");
           li.setAttribute("onclick","reply_click(this.id);");

           uname.setAttribute("style","word-wrap:break-word; align:center;padding-right:5px;");
           email.setAttribute("style","font-size:50%;word-wrap:break-word;align:center;padding-right:5px;");
           uname.textContent = doc.data().bio;
           email.textContent =doc.data().email;
           li.appendChild(uname);
           li.appendChild(email);
           document.getElementById("lists").appendChild(li);
           document.querySelector("#friendList").appendChild(li);
        }
      });
    });

      } else {
      // clear account info
    accountDetails.innerHTML = '';
    // toggle user elements
    loggedInLinks.forEach(item => item.style.display = 'none');
    loggedOutLinks.forEach(item => item.style.display = 'block');
  }
};

// setup materialize components
document.addEventListener('DOMContentLoaded', function() {

    var modals = document.querySelectorAll('.modal');
    M.Modal.init(modals);
  
    var items = document.querySelectorAll('.collapsible');
    M.Collapsible.init(items);
  
  });

</script>

<script type="text/javascript">
			/* set the global variables so we can use them wihin functions */
			var game_active = false; // this is a boolean (true/false values only).  This will be used to prevent being able to drop pieces once the game is over
			var active_player = 0; // the # of the active player - 1 or 2.  Default is 0, meaning no active player
			var active_player_email = "";
      var gameboard = []; // define the gameboard as an array.  We will later set it up as a multi-dimensional array, to represent the col/row value for the game board
			var player_color = []; //define player_color as an array
			player_color[1] = "red"; //set the player_color for player 1 to "red" 
			player_color[2] = "blue"; // set the player_color for player 2 to "blue"
			
			function beginGame() {
                window.count=0;
				if (game_active == true) return false; 

				game_active = true; 
				for (row=0; row<=5; row++) {
					gameboard[row] = [];
					for (col=0; col<=6; col++) {
						gameboard[row][col] = 0;
					}	
				}		
				drawBoard(); // call the function to draw the board.				
				active_player = 1; //set the first player as their turn
				setUpTurn(); //get ready for the player's turn
			}
			
			/* drawBoard will draw the board - it will update each item to make sure it is the appropriate value */
			function drawBoard() {
				checkForWin(); //check to see if any player has won.
				for (col = 0; col<=6; col++) {
					for (row=0; row<=5; row++) {
              document.getElementById('square_'+row+'_'+col).innerHTML ="<span class='piece player"+gameboard[row][col]+"'> </span>";
					}	
				}
			}
			
			function checkForWin() {
				for (i=1; i<=2; i++) {
					for (col = 0; col <=3; col++) {
						for (row = 0; row <=5; row++) {
							if (gameboard[row][col] == i) {
								if ((gameboard[row][col+1] == i) && (gameboard[row][col+2] == i) && (gameboard[row][col+3] == i)) {
									endGame(i);//a match has been made, so run EndGame with the player that had the win
									return true; //stop checking for a win - the game is over.
								}
							}
						}
					}
				}
				
				//check top-to-bottom
				for (i=1; i<=2; i++) {
					//since a winning row must be 4 long, we only need to check the first 3 rows, 0,1,and 2
					for (col = 0; col <=6; col++) {
						for (row = 0; row <=2; row++) {
							//check to see if the gameboard item is set to the player we are checking, if so, lets check the next 3 for a match
							if (gameboard[row][col] == i) {
								if ((gameboard[row+1][col] == i) && (gameboard[row+2][col] == i) && (gameboard[row+3][col] == i)) {
									endGame(i); //a match has been made - run endGame for the player who had the match.
									return true; //stop checking for a win - the game is over.
								}
							}
						}
					}
				}
				
				//check diagnol down
				for (i=1; i<=2; i++) {
					//since a winning row must be 4 long, we only need to check the first 3 rows, 0,1,and 2
					for (col = 0; col <=3; col++) {
						//we also only need to check the bottom most columns - as the win must be upwards
						for (row = 0; row <=2; row++) {
							//check to see if the gameboard item is set to the player we are checking, if so, lets check the next 3 for a match
							if (gameboard[row][col] == i) {
								if ((gameboard[row+1][col+1] == i) && (gameboard[row+2][col+2] == i) && (gameboard[row+3][col+3] == i)) {
									endGame(i);
									return true;
								}
							}
						}
					}
				}
								
				//check diagnol up
				for (i=1; i<=2; i++) {
					//since a winning row must be 4 long, we only need to check the first 3 rows, 0,1,and 2
					for (col = 0; col <=3; col++) {
						//we also only need to check the bottom most columns - as the win must be upwards
						for (row = 3; row <=5; row++) {
							//check to see if the gameboard item is set to the player we are checking, if so, lets check the next 3 for a match
							if (gameboard[row][col] == i) {
								if ((gameboard[row-1][col+1] == i) && (gameboard[row-2][col+2] == i) && (gameboard[row-3][col+3] == i)) {
									endGame(i);
									return true;
								}
							}
						}
					}
				}
			}
			
      
			/* endGame will end the game - any additional functions or things you want to happen when the game is over can go here */
			function endGame(winningPlayer) {
				game_active = false; //set the "game_active" to false, so that it can be started again.
                //alert("Winner: " + winningPlayer);
       database.ref('Connect4Game/'+dbs1+'/'+dbs2+'/FirstPlayer').on('value', snap =>{
           first = snap.val().first_play;
        });
        if(winningPlayer==1){
            if(first == window.userIs.email){
              document.getElementById('game_info').innerHTML = "You Won." ;
              document.getElementById("game_table").style.background ="#90B6F9";
            }
            else{
              document.getElementById('game_info').innerHTML = "You Lost." ;
              document.getElementById("game_table").style.background ="#90B6F9";
            }
        }
        if(winningPlayer==2 ){
          if(first == window.userIs.email){
            document.getElementById('game_info').innerHTML = "You Lost." ;
            document.getElementById("game_table").style.background ="#F694A9"; 
          }
          else{
            document.getElementById('game_info').innerHTML = "You Won." ;
            document.getElementById("game_table").style.background ="#F694A9";
          }
        }
				 //set the "game_info" to the winner and the winning player #
        window.count=1;
        
         
      }
			
			/* setUpTurn will display who is the active player */
			function setUpTurn() {
				if (game_active) { //only run this is the game is active.
					//display the current player, and create a <span> with the class of the player# so that it will show the color.
          //console.log(window.activeIs);
          database.ref('Connect4Game/'+dbs1+'/'+dbs2+'/ActivePlayerEmail').once('value', snap =>{
           //console.log(snap.val());
           var act = snap.val().active_play_email;
           //console.log(act, window.userIs.email);
            if(act == window.userIs.email && window.count==0){
            document.getElementById('game_info').innerHTML = "Current Player: Player " + active_player + " <span class='player"+active_player+"'>(" + player_color[active_player] + ")</span> (Your turn)"; 
          }
           if(act == window.toWhoms && window.count==0 ){
             document.getElementById('game_info').innerHTML = "Current Player: Player " + active_player + " <span class='player"+active_player+"'>(" + player_color[active_player] + ")</span> (Other player)";
           } 
            

          });
          
					
				}
			}	

      

      function callShowBox(n1, n2){
        window.count = 0;
        for (row=0; row<=5; row++) {
					gameboard[row] = [];
					for (col=0; col<=6; col++) {
						gameboard[row][col] = 0;
					}	
				}	
        game_active = true;
        drawBoard();
        database.ref('Connect4Game/'+dbs1+'/'+dbs2+'/ActivePlayer').on('value', snap =>{
           active_player = snap.val().active_play;
           setUpTurn(); //display who is the active player
        });
        var dbName1 = n1;
        var dbName2 = n2;
        database.ref('Connect4Game/'+dbName1+'/'+dbName2+'/moves').on('value', snap =>{
       //console.log(snap.val());
       snap.forEach(function(childSnapshot){
         document.getElementById("firstPlayer").disabled = true;
          var row = childSnapshot.val().row;
          var col = childSnapshot.val().col;
          var activePlay = childSnapshot.val().activeplayer;
          //console.log(gameboard);
          gameboard[row][col] = activePlay;

          drawBoard();
          
       });
       
      });
      }
      
      window.userDropped = 0;
			/* drop will add a piece to the lowest available column */
			function drop(col) {
        if(window.count ==0){
          console.log(window.track);
           database.ref('Connect4Game/'+dbs1+'/'+dbs2+'/FirstPlayer').on('value', snap =>{
           //console.log(snap.val());
           var first = snap.val().first_play;
        });
        database.ref('Connect4Game/'+dbs1+'/'+dbs2+'/ActivePlayerEmail').once('value', snap =>{
           //console.log(snap.val());
           try{
               var active = snap.val().active_play_email;
               window.activeIs = active;
           }
           catch{
             alert("Please select the Player 1");
           }
           if(active == window.userIs.email && document.getElementById("frstPlr").innerHTML !=""){
            if(window.userDropped == 0){
              window.userDropped++;
               for (row=5; row>=0; row--) { //note: we are using row--, which will reduce the value of row by 1, the opposted of ++
						    if (gameboard[row][col] == 0) {
							  //set the empty row to the active player's number
							  gameboard[row][col] = active_player;
                storeInDatabase(row,col,active_player,"+");
                callShowBox(window.dbs1, window.dbs2);
							  drawBoard(); // draw the board.
							//change the active players turn:
							if (active_player == 1) {
								active_player = 2;
							} else {
								active_player = 1;
							}
              if(active == window.userIs.email){
                active_play_emails = window.toWhoms
              }
              else{
                active_play_emails = window.userIs.email
              }
              database.ref('Connect4Game/'+db1+'/'+db2+'/ActivePlayer/').update({active_play:active_player});
              database.ref('Connect4Game/'+db1+'/'+db2+'/ActivePlayerEmail/').update({active_play_email:active_play_emails});
							//there is also a fancy way of doing this call a ternary assignment that looks like this: active_player = (active_player == 1) ? 2 : 1;
							
							setUpTurn(); //display who is the active player
                
							//stop looking for empty spaces
							return true;
						 }
             
					}


            } 
            
           }
        });

				  
       }
		 }
		function storeInDatabase(row,col,activePlayer, key){
      
       var emailSender = window.userIs.email.replace(/[^a-zA-Z0-9]/g, "");
       var emailReceiver = window.toWhom.replace(/[^a-zA-Z0-9]/g, "");

       var compare =  emailSender.localeCompare(emailReceiver);

       var time = new Date().toString().slice(16,21);
       if(compare == -1){
         dbName1 = emailSender;
         dbName2 = emailSender+'-'+emailReceiver;
       }
       else{
         dbName1 = emailReceiver;
         dbName2 = emailReceiver+'-'+emailSender;
       }
    if(key =="+"){
      //var value = document.getElementById(id).value;
        
       //var refGame = database.ref('TikTokToi/'+dbName1+'/'+dbName2);
       var data2 = {
              From : window.userIs.email,
              row : row,
              col : col,
              activeplayer : activePlayer
           }
           database.ref('Connect4Game/'+dbName1+'/'+dbName2+'/moves/'+row.toString()+col.toString()).update(data2).then( function(){
             window.userDropped = 0; // it is to prevent the user to click twice at a time before the data is updated into database.
           });
     }
     if(key == "-"){
       database.ref('Connect4Game/'+dbName1+'/'+dbName2+'/moves').remove();
       /*for(var i=1;i<10;i++){
        document.getElementById(i.toString()).value='';
        document.getElementById(i.toString()).disabled = false;
        if(dbName1 == window.userIs.email.replace(/[^a-zA-Z0-9]/g, "")){
          document.getElementById('whoseTurn').innerHTML = "Turn : You";
        }
        else{
          document.getElementById('whoseTurn').innerHTML = "Turn : Another Player";
        }
      }*/
     }
     //callShowBox(dbName1,dbName2);
     callShowBox(window.dbs1, window.dbs2);
   }	

		</script>

    

<script>
    function logouts(){
      document.querySelector("#friendList").innerHTML = "";
      document.getElementById("begin_game").innerHTML = "";
    document.getElementById("gameboard").innerHTML = "";
     auth.signOut();
        
  }
</script>

</body>
</html>